{% extends "base.html" %}
{% block content %}
  <section class="section">
    <div class="pagehead">
      <div>
        <h1 class="h1">Редактировать</h1>
        <div class="muted small">/p/{{ page.slug }}</div>
      </div>
      <a class="btn btn-small" href="{{ url_for('page_view', slug=page.slug) }}">Открыть</a>
    </div>
  </section>

  <form class="form" method="post" enctype="multipart/form-data">
    <label class="label">Название</label>
    <input class="input" type="text" name="title" maxlength="120" value="{{ page.title }}" required>

    <label class="label">Описание</label>
    <textarea class="textarea" name="description" rows="6" maxlength="6000" placeholder="Текст/инструкции/описание">{{ page.description }}</textarea>

    <label class="label">Ссылка (URL)</label>
    <input class="input" type="url" name="link_url" value="{{ page.link_url or '' }}" placeholder="https://...">

    <label class="label">Добавить файлы / видео (можно несколько)</label>
<div id="file-inputs" class="fileinputs">
  <input class="input" type="file" name="files" multiple>
</div>
<div class="row">
  <button class="btn btn-small" type="button" onclick="addFileInput()">+ Добавить ещё файл</button>
  <div class="muted small">Можно выбрать несколько файлов сразу (Ctrl/Shift), или добавить ещё поля.</div>
</div>

<script>
  function addFileInput() {
    const wrap = document.getElementById('file-inputs');
    if (!wrap) return;
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.name = 'files';
    inp.className = 'input';
    // don't force multiple on extra fields; one per field is OK, backend uses getlist()
    wrap.appendChild(inp);
  }
</script>

    <div class="row">
      <button class="btn btn-primary" type="submit">Сохранить</button>
      <a class="btn" href="{{ url_for('admin_pages') }}">Назад</a>
    </div>
  </form>

  {% if page.files and page.files|length > 0 %}
    <section class="section">
      <h2 class="h2">Вложения</h2>
      <p class="muted small">Удаление вложения не удаляет страницу — только файл.</p>
    </section>

    <div class="attachments">
      {% for f in page.files %}
        {% set ext = f.ext|lower %}
        <div class="att">
          {% if ext in ["jpg","jpeg","png","gif","webp"] %}
            <a class="att att-img" href="{{ f.url }}" target="_blank" rel="noopener">
              <img src="{{ f.url }}" alt="{{ f.name }}">
            </a>
          {% elif ext in ["mp4","webm","mov"] %}
            <div class="att att-video">
              <video controls preload="metadata" src="{{ f.url }}"></video>
              <div class="att__name">{{ f.name }}</div>
            </div>
          {% else %}
            <a class="att att-file" href="{{ f.url }}" target="_blank" rel="noopener">
              <span class="att__icon">⬇</span>
              <span class="att__name">{{ f.name }}</span>
            </a>
          {% endif %}

          <form class="att__del" method="post" action="{{ url_for('admin_delete_file', page_id=page.id) }}"
                onsubmit="return confirm('Удалить этот файл?');">
            <input type="hidden" name="filename" value="{{ f.name }}">
            <input type="hidden" name="slug" value="{{ page.slug }}">
            <button class="btn btn-danger btn-small" type="submit">Удалить файл</button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">Вложений пока нет.</div>
  {% endif %}
{% endblock %}
