{% extends "base.html" %}
{% block content %}
  <section class="section">
    <div class="pagehead">
      <div>
        <h1 class="h1">Редактировать карточку</h1>
        <div class="muted small">/c/{{ card.id }}</div>
      </div>
      <div class="row">
        <a class="btn btn-small" href="{{ url_for('card_view', card_id=card.id) }}">Открыть</a>
        <form method="post" action="{{ url_for('admin_delete_card', card_id=card.id) }}"
              onsubmit="return confirm('Удалить карточку полностью?');">
          <button class="btn btn-danger btn-small" type="submit">Удалить карточку</button>
        </form>
      </div>
    </div>
  </section>

  <form class="form" method="post" enctype="multipart/form-data">
    <label class="label">Название</label>
    <input class="input" type="text" name="title" maxlength="120" value="{{ card.title }}" required>

    <label class="label">Описание</label>
    <textarea class="textarea" name="description" rows="6" maxlength="6000">{{ card.description }}</textarea>

    <label class="label">Ссылка (URL)</label>
    <input class="input" type="text" name="link_url" value="{{ card.link_url or '' }}" placeholder="t.me/..., instagram.com/...">

    <label class="label">Добавить файлы / видео (можно несколько)</label>
    <input class="input" type="file" name="files" multiple>

    <div class="row">
      <button class="btn btn-primary" type="submit">Сохранить</button>
      <a class="btn" href="{{ url_for('admin_cards') }}">Назад</a>
    </div>
  </form>

  {% if card.files and card.files|length > 0 %}
    <section class="section">
      <h2 class="h2">Вложения</h2>
      <p class="muted small">Удаление вложения не удаляет карточку — только файл.</p>
    </section>

    <div class="attachments">
      {% for f in card.files %}
        {% set ext = f.ext|lower %}
        <div class="att">
          {% if ext in ["jpg","jpeg","png","gif","webp"] %}
            <a class="att att-img" href="{{ f.url }}" target="_blank" rel="noopener">
              <img src="{{ f.url }}" alt="{{ f.name }}">
            </a>
          {% elif ext in ["mp4","webm","mov"] %}
            <div class="att att-video">
              <video controls preload="metadata" src="{{ f.url }}"></video>
              <div class="att__name">{{ f.name }}</div>
            </div>
          {% else %}
            <a class="att att-file" href="{{ f.url }}" target="_blank" rel="noopener">
              <span class="att__icon">⬇</span>
              <span class="att__name">{{ f.name }}</span>
            </a>
          {% endif %}

          <form class="att__del" method="post" action="{{ url_for('admin_delete_card_file', card_id=card.id) }}"
                onsubmit="return confirm('Удалить этот файл?');">
            <input type="hidden" name="filename" value="{{ f.name }}">
            <button class="btn btn-danger btn-small" type="submit">Удалить файл</button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">Вложений пока нет.</div>
  {% endif %}
{% endblock %}
